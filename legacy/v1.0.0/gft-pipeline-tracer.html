<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GFT Pipeline Tracer â€” Rei (0â‚€å¼) Debug & Education Tool</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,500;0,700;1,300&family=IBM+Plex+Mono:wght@300;400;500&family=Noto+Serif+JP:wght@300;400;600&display=swap');

:root {
  --void: #08080f;
  --deep: #0c0c16;
  --panel: #111122;
  --surface: #181830;
  --surface2: #1e1e3a;
  --border: rgba(196,162,101,0.12);
  --border-active: rgba(196,162,101,0.35);
  --ink: #d8d4cc;
  --ink-dim: #8a867e;
  --silver: #9a968e;
  --gold: #c4a265;
  --gold-dim: #8a7245;
  --gold-glow: rgba(196,162,101,0.15);
  --rei-blue: #5a8fc5;
  --rei-glow: rgba(90,143,197,0.2);
  --green: #5ec47a;
  --green-glow: rgba(94,196,122,0.15);
  --red: #c46565;
  --red-glow: rgba(196,101,101,0.15);
  --purple: #9b7ed8;
  --purple-glow: rgba(155,126,216,0.15);
  --cyan: #5abfc4;
  --cyan-glow: rgba(90,191,196,0.15);
  --orange: #d4a04a;
}

* { margin:0; padding:0; box-sizing:border-box; }

html { font-size: 15px; }

body {
  background: var(--void);
  color: var(--ink);
  font-family: 'Noto Serif JP', 'Cormorant Garamond', serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* === Background Texture === */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse at 20% 20%, rgba(196,162,101,0.03) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 80%, rgba(90,143,197,0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* === Layout === */
.app {
  position: relative;
  z-index: 1;
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
}

/* === Header === */
.header {
  text-align: center;
  margin-bottom: 2.5rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.header h1 {
  font-family: 'Cormorant Garamond', serif;
  font-weight: 300;
  font-size: 2.2rem;
  letter-spacing: 0.08em;
  color: var(--gold);
  margin-bottom: 0.3rem;
}

.header h1 span.rei {
  font-weight: 700;
  font-size: 2.6rem;
}

.header .subtitle {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
  color: var(--ink-dim);
  letter-spacing: 0.15em;
  text-transform: uppercase;
}

/* === Tab Navigation === */
.tabs {
  display: flex;
  gap: 0;
  margin-bottom: 2rem;
  border-bottom: 1px solid var(--border);
}

.tab {
  padding: 0.8rem 1.5rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.8rem;
  font-weight: 400;
  letter-spacing: 0.06em;
  color: var(--ink-dim);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.tab:hover { color: var(--ink); }

.tab.active {
  color: var(--gold);
  border-bottom-color: var(--gold);
}

.tab .badge {
  display: inline-block;
  background: var(--surface2);
  color: var(--ink-dim);
  font-size: 0.6rem;
  padding: 0.1em 0.5em;
  border-radius: 8px;
  margin-left: 0.5em;
  vertical-align: middle;
}

.tab.active .badge {
  background: var(--gold-glow);
  color: var(--gold);
}

/* === Panels === */
.panel { display: none; }
.panel.active { display: block; }

/* === Pipeline Tracer === */
.pipeline-controls {
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.control-group label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
  color: var(--ink-dim);
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

input[type="range"] {
  -webkit-appearance: none;
  width: 160px;
  height: 4px;
  background: var(--surface2);
  border-radius: 2px;
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--gold);
  cursor: pointer;
  box-shadow: 0 0 8px var(--gold-glow);
}

.btn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
  padding: 0.5rem 1.2rem;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--ink-dim);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.04em;
}

.btn:hover {
  border-color: var(--border-active);
  color: var(--ink);
  background: var(--surface2);
}

.btn.active, .btn.primary {
  border-color: var(--gold-dim);
  color: var(--gold);
  background: var(--gold-glow);
}

.btn.danger {
  border-color: rgba(196,101,101,0.3);
  color: var(--red);
}

.btn.danger:hover {
  background: var(--red-glow);
}

/* === SVG Canvas === */
.graph-container {
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 1.5rem;
  position: relative;
  overflow: hidden;
}

.graph-container svg {
  width: 100%;
  display: block;
}

/* === Step Timeline === */
.timeline {
  display: flex;
  align-items: center;
  gap: 0;
  margin-bottom: 2rem;
  padding: 1rem;
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow-x: auto;
}

.timeline-step {
  display: flex;
  align-items: center;
  flex-shrink: 0;
}

.step-node {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
  font-weight: 500;
  border: 2px solid var(--border);
  background: var(--panel);
  color: var(--ink-dim);
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.step-node:hover {
  border-color: var(--border-active);
  color: var(--ink);
}

.step-node.completed {
  border-color: var(--green);
  color: var(--green);
  background: var(--green-glow);
}

.step-node.current {
  border-color: var(--gold);
  color: var(--gold);
  background: var(--gold-glow);
  box-shadow: 0 0 16px var(--gold-glow);
}

.step-node.rejected {
  border-color: var(--red);
  color: var(--red);
  background: var(--red-glow);
}

.step-connector {
  width: 40px;
  height: 2px;
  background: var(--border);
  flex-shrink: 0;
}

.step-connector.completed {
  background: var(--green);
  box-shadow: 0 0 4px var(--green-glow);
}

.step-connector.rejected {
  background: var(--red);
  background: repeating-linear-gradient(90deg, var(--red) 0 4px, transparent 4px 8px);
}

.step-label {
  position: absolute;
  top: 54px;
  left: 50%;
  transform: translateX(-50%);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  color: var(--ink-dim);
  white-space: nowrap;
  letter-spacing: 0.04em;
}

/* === Inspector Panel === */
.inspector {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

@media (max-width: 800px) {
  .inspector { grid-template-columns: 1fr; }
}

.inspector-card {
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1.2rem;
}

.inspector-card h3 {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
  font-weight: 500;
  color: var(--gold);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 0.8rem;
  padding-bottom: 0.4rem;
  border-bottom: 1px solid var(--border);
}

.kv-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  padding: 0.25rem 0;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
}

.kv-key { color: var(--ink-dim); }
.kv-val { color: var(--ink); font-weight: 500; }
.kv-val.green { color: var(--green); }
.kv-val.red { color: var(--red); }
.kv-val.gold { color: var(--gold); }
.kv-val.blue { color: var(--rei-blue); }
.kv-val.purple { color: var(--purple); }

/* === Diff View === */
.diff-view {
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1.2rem;
  margin-bottom: 1.5rem;
}

.diff-view h3 {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
  font-weight: 500;
  color: var(--gold);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 0.8rem;
}

.diff-line {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
  padding: 0.2rem 0.6rem;
  border-radius: 2px;
  margin-bottom: 2px;
}

.diff-line.added {
  background: rgba(94,196,122,0.08);
  color: var(--green);
}

.diff-line.removed {
  background: rgba(196,101,101,0.08);
  color: var(--red);
}

.diff-line.unchanged {
  color: var(--ink-dim);
}

.diff-line .prefix {
  display: inline-block;
  width: 1.5em;
  color: inherit;
  opacity: 0.6;
}

/* === Attack Cards === */
.attack-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.attack-card {
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.3s;
}

.attack-card:hover {
  border-color: var(--border-active);
  transform: translateY(-1px);
}

.attack-card.selected {
  border-color: var(--red);
  box-shadow: 0 0 12px var(--red-glow);
}

.attack-category {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  color: var(--red);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 0.4rem;
}

.attack-name {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  color: var(--ink);
  margin-bottom: 0.4rem;
}

.attack-desc {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
  color: var(--ink-dim);
  line-height: 1.5;
}

.attack-result {
  margin-top: 0.6rem;
  padding-top: 0.6rem;
  border-top: 1px solid var(--border);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
}

.attack-result .blocked {
  color: var(--green);
}

.attack-result .stage {
  color: var(--gold);
}

/* === Education Mode === */
.edu-question {
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.edu-question .q-number {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.65rem;
  color: var(--gold);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 0.6rem;
}

.edu-question .q-text {
  font-size: 1rem;
  line-height: 1.7;
  margin-bottom: 1rem;
}

.edu-question .q-code {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.8rem 1rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.8rem;
  color: var(--cyan);
  margin-bottom: 1rem;
  overflow-x: auto;
  white-space: pre;
}

.choice-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.choice-item {
  display: flex;
  align-items: flex-start;
  gap: 0.8rem;
  padding: 0.7rem 1rem;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.8rem;
  line-height: 1.5;
}

.choice-item:hover {
  border-color: var(--border-active);
  background: var(--surface);
}

.choice-item.correct {
  border-color: var(--green);
  background: var(--green-glow);
}

.choice-item.wrong {
  border-color: var(--red);
  background: var(--red-glow);
}

.choice-marker {
  flex-shrink: 0;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 1.5px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.65rem;
  color: var(--ink-dim);
  margin-top: 0.1em;
}

.choice-item.correct .choice-marker {
  border-color: var(--green);
  color: var(--green);
}

.choice-item.wrong .choice-marker {
  border-color: var(--red);
  color: var(--red);
}

.explanation {
  margin-top: 1rem;
  padding: 1rem;
  background: var(--surface);
  border-left: 3px solid var(--gold);
  border-radius: 0 4px 4px 0;
  font-size: 0.85rem;
  line-height: 1.7;
  color: var(--ink);
  display: none;
}

.explanation.show { display: block; }

.explanation .exp-title {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
  color: var(--gold);
  letter-spacing: 0.08em;
  margin-bottom: 0.5rem;
}

/* === Genesis Visualizer === */
.genesis-track {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  padding: 2rem 1rem;
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 1.5rem;
  overflow-x: auto;
}

.genesis-phase {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  transition: all 0.3s;
  flex-shrink: 0;
}

.genesis-phase:hover .phase-circle {
  transform: scale(1.1);
}

.phase-circle {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid var(--border);
  background: var(--panel);
  transition: all 0.4s;
  position: relative;
}

.phase-circle .phase-symbol {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.4rem;
  color: var(--ink-dim);
}

.phase-circle.reached {
  border-color: var(--gold);
  background: var(--gold-glow);
}

.phase-circle.reached .phase-symbol {
  color: var(--gold);
}

.phase-circle.active-phase {
  border-color: var(--gold);
  box-shadow: 0 0 20px var(--gold-glow), 0 0 40px rgba(196,162,101,0.08);
}

.phase-name {
  margin-top: 0.6rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.65rem;
  color: var(--ink-dim);
  letter-spacing: 0.04em;
}

.genesis-arrow {
  width: 50px;
  height: 2px;
  background: var(--border);
  position: relative;
  flex-shrink: 0;
}

.genesis-arrow.reached {
  background: var(--gold);
}

.genesis-arrow::after {
  content: '';
  position: absolute;
  right: -4px;
  top: -3px;
  width: 0;
  height: 0;
  border-left: 6px solid var(--border);
  border-top: 4px solid transparent;
  border-bottom: 4px solid transparent;
}

.genesis-arrow.reached::after {
  border-left-color: var(--gold);
}

.axiom-label {
  position: absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.55rem;
  color: var(--ink-dim);
  white-space: nowrap;
}

.genesis-arrow.reached .axiom-label {
  color: var(--gold-dim);
}

/* === Score / Progress === */
.score-bar {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.8rem 1.2rem;
  background: var(--deep);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 1.5rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.8rem;
}

.score-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.score-item .label { color: var(--ink-dim); font-size: 0.7rem; }
.score-item .value { color: var(--gold); font-weight: 500; }

/* === Scrollbar === */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--void); }
::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }

/* === Animations === */
@keyframes pulseGold {
  0%, 100% { box-shadow: 0 0 8px var(--gold-glow); }
  50% { box-shadow: 0 0 20px var(--gold-glow), 0 0 40px rgba(196,162,101,0.05); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.4s ease forwards;
}

/* === Code Highlight Spans === */
.hl-kw { color: var(--purple); }
.hl-fn { color: var(--rei-blue); }
.hl-type { color: var(--gold); }
.hl-str { color: var(--green); }
.hl-comment { color: var(--ink-dim); font-style: italic; }
.hl-err { color: var(--red); text-decoration: wavy underline var(--red); }
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <h1><span class="rei">GFT</span> Pipeline Tracer</h1>
    <div class="subtitle">Rei (0â‚€å¼) â€” ISL Debug & Education Tool &nbsp;â”‚&nbsp; D-FUMT / Nobuki Fujimoto</div>
  </header>

  <!-- Tabs -->
  <nav class="tabs">
    <button class="tab active" data-tab="tracer">Pipeline Tracer<span class="badge">ISL</span></button>
    <button class="tab" data-tab="genesis">Genesis Viewer<span class="badge">GA-v2</span></button>
    <button class="tab" data-tab="attacks">Attack Replay<span class="badge">31</span></button>
    <button class="tab" data-tab="education">Education<span class="badge">å•é¡Œé›†</span></button>
  </nav>

  <!-- ===== PANEL 1: Pipeline Tracer ===== -->
  <div class="panel active" id="panel-tracer">
    <!-- Controls -->
    <div class="pipeline-controls">
      <div class="control-group">
        <label>Energy</label>
        <input type="range" id="energy-slider" min="0.05" max="0.8" step="0.05" value="0.3">
        <span id="energy-val" class="kv-val gold" style="font-family:'IBM Plex Mono';font-size:0.8rem;">0.30</span>
      </div>
      <button class="btn primary" id="btn-run">â–¶ Run Genesis + ISL</button>
      <button class="btn" id="btn-step">Step â–¸</button>
      <button class="btn" id="btn-reset">Reset</button>
    </div>

    <!-- Timeline -->
    <div class="timeline" id="pipeline-timeline"></div>

    <!-- Graph SVG -->
    <div class="graph-container" id="graph-container">
      <svg id="gft-svg" viewBox="0 0 1000 400" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>

    <!-- Diff View -->
    <div class="diff-view" id="diff-view">
      <h3>State Diff</h3>
      <div id="diff-content"></div>
    </div>

    <!-- Inspector -->
    <div class="inspector" id="inspector">
      <div class="inspector-card">
        <h3>Pipeline State</h3>
        <div id="inspect-state"></div>
      </div>
      <div class="inspector-card">
        <h3>Witness / Proof</h3>
        <div id="inspect-witness"></div>
      </div>
    </div>
  </div>

  <!-- ===== PANEL 2: Genesis Viewer ===== -->
  <div class="panel" id="panel-genesis">
    <div class="pipeline-controls">
      <div class="control-group">
        <label>Energy</label>
        <input type="range" id="gen-energy" min="0.05" max="0.8" step="0.05" value="0.3">
        <span id="gen-energy-val" class="kv-val gold" style="font-family:'IBM Plex Mono';font-size:0.8rem;">0.30</span>
      </div>
      <button class="btn primary" id="btn-gen-run">â–¶ Run Genesis</button>
      <button class="btn" id="btn-gen-step">Tick â–¸</button>
      <button class="btn" id="btn-gen-reset">Reset</button>
    </div>

    <!-- Genesis Track -->
    <div class="genesis-track" id="genesis-track"></div>

    <!-- Genesis State Inspector -->
    <div class="inspector">
      <div class="inspector-card">
        <h3>Genesis State</h3>
        <div id="gen-state-info"></div>
      </div>
      <div class="inspector-card">
        <h3>Transition History</h3>
        <div id="gen-history"></div>
      </div>
    </div>

    <!-- Genesis SVG -->
    <div class="graph-container">
      <svg id="genesis-svg" viewBox="0 0 1000 350" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
  </div>

  <!-- ===== PANEL 3: Attack Replay ===== -->
  <div class="panel" id="panel-attacks">
    <p style="font-size:0.85rem;color:var(--ink-dim);margin-bottom:1.5rem;line-height:1.7;">
      ISLã®æ•µå¯¾çš„ãƒ†ã‚¹ãƒˆ31ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¦–è¦šåŒ–ã€‚å„æ”»æ’ƒãŒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ã©ã®æ®µéšã§æ¤œå‡ºãƒ»æ‹’å¦ã•ã‚Œã‚‹ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
    </p>
    <div class="attack-grid" id="attack-grid"></div>
    <div id="attack-detail" style="display:none;">
      <div class="timeline" id="attack-timeline"></div>
      <div class="diff-view">
        <h3>Attack Analysis</h3>
        <div id="attack-analysis"></div>
      </div>
    </div>
  </div>

  <!-- ===== PANEL 4: Education ===== -->
  <div class="panel" id="panel-education">
    <div class="score-bar">
      <div class="score-item"><span class="label">æ­£è§£</span><span class="value" id="edu-correct">0</span></div>
      <div class="score-item"><span class="label">ä¸æ­£è§£</span><span class="value" style="color:var(--red)" id="edu-wrong">0</span></div>
      <div class="score-item"><span class="label">é€²æ—</span><span class="value" id="edu-progress">0 / 0</span></div>
    </div>
    <div id="edu-questions"></div>
  </div>
</div>

<script>
// ============================================================
// GFT Pipeline Tracer â€” Core Engine
// ============================================================

// === Genesis Axiom System (Simplified for Visualization) ===
const PHASES = ['void', 'dot', 'zero_zero', 'zero', 'number'];
const PHASE_SYMBOLS = { void: 'âˆ…', dot: 'ãƒ»', zero_zero: '0â‚€', zero: '0', number: 'â„•' };
const PHASE_AXIOMS = ['', 'G-Eâ‚', 'G-Sâ‚€', 'G-Sâ‚', 'G-Nâ‚'];
const THRESHOLDS = { 'voidâ†’dot': 0.1, 'dotâ†’zero_zero': 0.35, 'zero_zeroâ†’zero': 0.6, 'zeroâ†’number': 0.85 };

const CURVATURE_THRESHOLD = 0.8;
const ENTROPY_DECAY = 0.02;
const STRUCTURE_GROWTH = 0.03;

function fnv1a32(str) {
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 0x01000193);
  }
  return ('00000000' + (h >>> 0).toString(16)).slice(-8);
}

function createGenesisState(energy = 0.3) {
  return {
    phase: 'void', tick: 0,
    curvature: 0, entropy: 1.0, structure: 0.0,
    energy, transitions: [], witnesses: []
  };
}

function computeProgress(state) {
  const idx = PHASES.indexOf(state.phase);
  if (idx >= PHASES.length - 1) return 1;
  const key = state.phase + 'â†’' + PHASES[idx + 1];
  const threshold = THRESHOLDS[key] || 1;
  return state.curvature / threshold;
}

function checkCS(state, energy) {
  return {
    holds: state.structure > 0 && energy > 0 && state.entropy > 0,
    structurePositive: state.structure > 0,
    energyPositive: energy > 0,
    entropyPositive: state.entropy > 0
  };
}

function genesisStep(state) {
  const s = { ...state, tick: state.tick + 1, transitions: [...state.transitions], witnesses: [...state.witnesses] };
  // Physics
  s.curvature += s.energy;
  s.entropy = Math.max(0, s.entropy - ENTROPY_DECAY);
  s.structure = Math.min(1, s.structure + STRUCTURE_GROWTH);

  // Check transition
  const idx = PHASES.indexOf(s.phase);
  if (idx < PHASES.length - 1) {
    const next = PHASES[idx + 1];
    const key = s.phase + 'â†’' + next;
    const threshold = THRESHOLDS[key];
    const progress = s.curvature / threshold;
    if (progress >= 1) {
      const cs = checkCS(s, s.energy);
      const payload = {
        from: s.phase, to: next, tick: s.tick,
        curvature: s.curvature, entropy: s.entropy,
        structure: s.structure, threshold, progress,
        cs
      };
      const hash = fnv1a32(JSON.stringify(payload));
      s.witnesses.push({ kind: PHASE_AXIOMS[idx + 1], hash, payload });
      s.transitions.push({ from: s.phase, to: next, tick: s.tick, axiom: PHASE_AXIOMS[idx + 1] });
      s.phase = next;
      s.curvature = 0;
    }
  }
  return s;
}

function runFullGenesis(energy = 0.3) {
  let s = createGenesisState(energy);
  const history = [{ ...s }];
  for (let i = 0; i < 200 && s.phase !== 'number'; i++) {
    s = genesisStep(s);
    history.push({ ...s });
  }
  return { final: s, history };
}

// === ISL Pipeline (Simplified for Visualization) ===
const PIPELINE_STAGES = [
  { id: 'init', label: 'Init', type: 'open' },
  { id: 'firewall_phi', label: 'FW-Î¦', type: 'check' },
  { id: 'phi_pre', label: 'Î¦-pre', type: 'transform' },
  { id: 'phi_apply', label: 'Î¦-apply', type: 'transform' },
  { id: 'phi_post', label: 'Î¦-post', type: 'check' },
  { id: 'phi_mark', label: 'Î¦-mark', type: 'mark' },
  { id: 'firewall_psi', label: 'FW-Î¨', type: 'check' },
  { id: 'psi_pre', label: 'Î¨-pre', type: 'transform' },
  { id: 'psi_apply', label: 'Î¨-apply', type: 'transform' },
  { id: 'psi_post', label: 'Î¨-post', type: 'check' },
  { id: 'psi_seal', label: 'Î¨-seal', type: 'seal' },
  { id: 'firewall_omega', label: 'FW-Î©', type: 'check' },
  { id: 'omega_apply', label: 'Î©-apply', type: 'transform' },
  { id: 'omega_compact', label: 'Î©-compact', type: 'compact' },
];

function createPipelineState(genesisState) {
  return {
    stage: 'open',
    stageIndex: 0,
    genesisPhase: genesisState.phase,
    invariants: {
      transitionCount: genesisState.transitions.length,
      witnessCount: genesisState.witnesses.length,
      phaseProgression: PHASES.indexOf(genesisState.phase),
      allCSHeld: genesisState.witnesses.every(w => w.payload.cs.holds),
    },
    marks: [],
    sealProof: null,
    compactProof: null,
    history: [],
    normalized: false,
    sealed: false,
    compacted: false,
  };
}

function advancePipeline(pState, genesisState) {
  const s = JSON.parse(JSON.stringify(pState));
  const stageInfo = PIPELINE_STAGES[s.stageIndex];
  if (!stageInfo || s.stageIndex >= PIPELINE_STAGES.length) return s;

  const prev = JSON.parse(JSON.stringify(s));

  switch (stageInfo.id) {
    case 'init':
      s.history.push({ stage: 'init', msg: 'Pipeline created (Open)' });
      break;
    case 'firewall_phi':
      if (s.sealed || s.compacted) {
        s.history.push({ stage: 'firewall_phi', msg: 'ğŸš« REJECTED: Cannot apply Î¦ to sealed/compacted', rejected: true });
        return s;
      }
      s.history.push({ stage: 'firewall_phi', msg: 'âœ“ Firewall passed: pipeline is Open' });
      break;
    case 'phi_pre':
      s.history.push({ stage: 'phi_pre', msg: 'Î¦ pre-check: verifying transition count & witness integrity' });
      break;
    case 'phi_apply':
      s.normalized = true;
      s.invariants.normalized = true;
      s.history.push({ stage: 'phi_apply', msg: 'Î¦ applied: state normalized (curvature rounded, entropy bounded)' });
      break;
    case 'phi_post':
      s.history.push({ stage: 'phi_post', msg: 'Î¦ post-check: invariants preserved âœ“' });
      break;
    case 'phi_mark': {
      const markId = 'mark_' + Date.now();
      s.marks.push({ id: markId, rule: 'PHI_NORMALIZE', tick: Date.now() });
      s.history.push({ stage: 'phi_mark', msg: `Î¦ mark recorded: ${markId.slice(0,12)}â€¦` });
      break;
    }
    case 'firewall_psi':
      if (s.sealed || s.compacted) {
        s.history.push({ stage: 'firewall_psi', msg: 'ğŸš« REJECTED: Cannot apply Î¨ to sealed/compacted', rejected: true });
        return s;
      }
      s.history.push({ stage: 'firewall_psi', msg: 'âœ“ Firewall passed: pipeline is Open (pre-Î¨)' });
      break;
    case 'psi_pre':
      s.history.push({ stage: 'psi_pre', msg: 'Î¨ pre-check: require normalized=true' });
      break;
    case 'psi_apply':
      s.history.push({ stage: 'psi_apply', msg: 'Î¨ applied: preparing seal proof' });
      break;
    case 'psi_post':
      s.history.push({ stage: 'psi_post', msg: 'Î¨ post-check: all invariants + CS verified âœ“' });
      break;
    case 'psi_seal': {
      const snapshot = JSON.stringify(s.invariants);
      s.sealProof = {
        hash: fnv1a32(snapshot),
        snapshot: s.invariants,
        markChainHash: fnv1a32(JSON.stringify(s.marks)),
        allCSHeld: s.invariants.allCSHeld,
      };
      s.sealed = true;
      s.stage = 'sealed';
      s.history.push({ stage: 'psi_seal', msg: `Î¨ sealed âœ“ proof=${s.sealProof.hash}` });
      break;
    }
    case 'firewall_omega':
      if (!s.sealed || s.compacted) {
        s.history.push({ stage: 'firewall_omega', msg: 'ğŸš« REJECTED: Î© requires Sealed state', rejected: true });
        return s;
      }
      s.history.push({ stage: 'firewall_omega', msg: 'âœ“ Firewall passed: pipeline is Sealed' });
      break;
    case 'omega_apply':
      s.history.push({ stage: 'omega_apply', msg: 'Î© applied: computing compact proof' });
      break;
    case 'omega_compact': {
      const compactData = JSON.stringify({ seal: s.sealProof, invariants: s.invariants });
      s.compactProof = {
        hash: fnv1a32(compactData),
        sealHash: s.sealProof.hash,
        transformCount: s.invariants.transitionCount,
        phaseProgression: s.invariants.phaseProgression,
        markChainHash: s.sealProof.markChainHash,
        allCSHeld: s.invariants.allCSHeld,
      };
      s.compacted = true;
      s.stage = 'compacted';
      s.history.push({ stage: 'omega_compact', msg: `Î© compacted âœ“ proof=${s.compactProof.hash}` });
      break;
    }
  }

  s.stageIndex++;
  return s;
}

// === Attack Definitions ===
const ATTACKS = [
  { cat: 'History Tampering', name: 'é·ç§»è¿½åŠ ', desc: 'transitionsé…åˆ—ã«å½ã®é·ç§»ã‚’æŒ¿å…¥', blocked: 'Î¨-post', detail: 'sealProof.snapshot.transitionCount ãŒå®Ÿéš›ã®é·ç§»æ•°ã¨ä¸ä¸€è‡´ â†’ Î¨ post-check ã§æ¤œå‡º' },
  { cat: 'History Tampering', name: 'é·ç§»å‰Šé™¤', desc: 'transitionsé…åˆ—ã‹ã‚‰æ­£è¦ã®é·ç§»ã‚’é™¤å»', blocked: 'Î¨-post', detail: 'witnessCount ã¨ transitionCount ã®ä¸æ•´åˆ â†’ æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã§æ¤œå‡º' },
  { cat: 'History Tampering', name: 'é·ç§»å…¥æ›¿', desc: 'transitions ã® from/to ã‚’å…¥ã‚Œæ›¿ãˆ', blocked: 'Î¦-post', detail: 'phaseProgression ã®å˜èª¿å¢—åŠ ãŒç ´å£Šã•ã‚Œã‚‹ â†’ Î¦æ­£è¦åŒ–å¾Œã®æ¤œè¨¼ã§æ¤œå‡º' },
  { cat: 'History Tampering', name: 'é·ç§»æ”¹ç«„', desc: 'transition.tick ã‚’æ”¹ç«„', blocked: 'Î¨-post', detail: 'witness.payload.tick ã¨ transition.tick ã®ä¸ä¸€è‡´ â†’ ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼å¤±æ•—' },
  { cat: 'Witness Attack', name: 'kindå·®æ›¿', desc: 'witness.kind ã‚’åˆ¥ã®å€¤ã«å¤‰æ›´', blocked: 'Î¦-pre', detail: 'witnessKindForPhase(from) ã¨ kind ãŒä¸ä¸€è‡´ â†’ ç¨®åˆ¥æ•´åˆãƒã‚§ãƒƒã‚¯ã§æ¤œå‡º' },
  { cat: 'Witness Attack', name: 'hashæ”¹ç«„', desc: 'witness.hash ã‚’å½ã®ãƒãƒƒã‚·ãƒ¥ã«ç½®æ›', blocked: 'Î¦-pre', detail: 'payload ã‹ã‚‰å†è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥ã¨æ¯”è¼ƒ â†’ ä¸ä¸€è‡´ã§å³æ¤œå‡º' },
  { cat: 'Witness Attack', name: 'payloadå¤‰æ›´', desc: 'witness.payload.curvature ã‚’æ”¹ç«„', blocked: 'Î¦-pre', detail: 'ãƒãƒƒã‚·ãƒ¥å†è¨ˆç®—ã§æ”¹ç«„æ¤œå‡ºï¼ˆFNV-1a ã¯ payload å…¨ä½“ã‚’ã‚«ãƒãƒ¼ï¼‰' },
  { cat: 'Witness Attack', name: 'å†è¨ˆç®—æ”»æ’ƒ', desc: 'payloadæ”¹ç«„å¾Œã«hashã‚‚å†è¨ˆç®—', blocked: 'Î¨-post', detail: 'curvature/threshold/progress ã®ç‰©ç†çš„æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã§æ¤œå‡ºï¼ˆprogress â‰  curvature/thresholdï¼‰' },
  { cat: 'Seal Proof Forgery', name: 'hashå½é€ ', desc: 'sealProof.hash ã‚’æ›¸ãæ›ãˆ', blocked: 'FW-Î©', detail: 'Î© firewall ãŒ snapshot ã‹ã‚‰å†è¨ˆç®— â†’ ãƒãƒƒã‚·ãƒ¥ä¸ä¸€è‡´ã§æ‹’å¦' },
  { cat: 'Seal Proof Forgery', name: 'snapshotä¸ä¸€è‡´', desc: 'sealProof.snapshot ã‚’å·®ã—æ›¿ãˆ', blocked: 'FW-Î©', detail: 'snapshot ãƒãƒƒã‚·ãƒ¥å†è¨ˆç®— â†’ sealProof.hash ã¨ã®ä¸ä¸€è‡´ã§æ¤œå‡º' },
  { cat: 'Seal Proof Forgery', name: 'invariantå½è£…', desc: 'ä¸å¤‰é‡ã‚’å…¨ã¦ã€Œæ­£å¸¸ã€ã«å½è£…', blocked: 'Î©-apply', detail: 'compactProof ç”Ÿæˆæ™‚ã«å®Ÿéš›ã® invariants ã¨ç…§åˆ â†’ å½è£…å€¤ã¨ã®ä¸ä¸€è‡´' },
  { cat: 'Seal Proof Forgery', name: 'CSå½è£…', desc: 'allCSHeld ã‚’ true ã«æ”¹ç«„', blocked: 'Î¨-post', detail: 'witnesses å…¨ä½“ã‚’å†èµ°æŸ»ã—ã€cs.holds ã® AND ã‚’å†è¨ˆç®— â†’ ä¸ä¸€è‡´æ¤œå‡º' },
  { cat: 'Mark Chain Attack', name: 'gapï¼ˆæ¬ è½ï¼‰', desc: 'markChain ã‹ã‚‰ä¸­é–“ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤', blocked: 'Î¨-seal', detail: 'markChainHash ã®å†è¨ˆç®— â†’ æ¬ è½ã«ã‚ˆã‚Šå…¨ãç•°ãªã‚‹ãƒãƒƒã‚·ãƒ¥' },
  { cat: 'Mark Chain Attack', name: 'reorder', desc: 'markChain ã®é †åºã‚’å…¥ã‚Œæ›¿ãˆ', blocked: 'Î¨-seal', detail: 'markChainHash ã¯é…åˆ—é †åºã«ä¾å­˜ â†’ å…¥æ›¿ã§ãƒãƒƒã‚·ãƒ¥å¤‰åŒ–' },
  { cat: 'Mark Chain Attack', name: 'duplicate', desc: 'åŒä¸€ãƒãƒ¼ã‚¯ã‚’äºŒé‡æŒ¿å…¥', blocked: 'Î¨-seal', detail: 'mark.id ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ + markChainHash ä¸ä¸€è‡´' },
  { cat: 'Mark Chain Attack', name: 'parentIdæ”¹ç«„', desc: 'mark.parentId ã‚’åˆ¥ãƒãƒ¼ã‚¯ã«å‘ã‘ã‚‹', blocked: 'Î¨-seal', detail: 'ãƒã‚§ãƒ¼ãƒ³æ•´åˆæ€§æ¤œæŸ»ï¼ˆå„ mark ã® parentId â†’ å‰ mark.id ã®ä¸€è‡´ï¼‰ã§æ¤œå‡º' },
  { cat: 'Phase Regression', name: 'é€†è¡Œ', desc: 'phase ã‚’ numberâ†’zero ã«æˆ»ã™', blocked: 'FW-Î¦', detail: 'firewallCheck: phaseDelta < 0 â†’ å˜èª¿æ€§é•åã§å³æ‹’å¦' },
  { cat: 'Phase Regression', name: 'æ®µé£›ã°ã—', desc: 'phase ã‚’ voidâ†’zero ã«é£›ã°ã™', blocked: 'FW-Î¦', detail: 'firewallCheck: phaseDelta > 1 â†’ æ®µé£›ã°ã—ç¦æ­¢ã§æ‹’å¦' },
  { cat: 'Type Cast Bypass', name: 'Sealedâ†’Open cast', desc: 'as unknown as OpenPipeline ã§å‹ã‚’è¿‚å›', blocked: 'FW-Î¦', detail: 'ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  firewall ãŒ sealed=true ã‚’æ¤œå‡º â†’ TypeScript ã®å‹ã‚’ç„¡è¦–ã—ã¦ã‚‚é˜²å¾¡' },
  { cat: 'Type Cast Bypass', name: 'Openâ†’Compact cast', desc: 'æœªå°å°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’Compactedã«å½è£…', blocked: 'FW-Î©', detail: 'sealProof ãŒ null â†’ Î© firewall ãŒã€ŒSealed çŠ¶æ…‹ã§ãªã„ã€ã¨æ‹’å¦' },
  { cat: 'Type Cast Bypass', name: 'Compactâ†’Open cast', desc: 'Compacted ã‚’ Open ã«æˆ»ã™è©¦ã¿', blocked: 'FW-Î¦', detail: 'compacted=true ã‚’ firewall ãŒæ¤œå‡º â†’ ä¸å¯é€†æ€§ã‚’å®Ÿè¡Œæ™‚ã«å¼·åˆ¶' },
  { cat: 'Type Cast Bypass', name: 'double seal', desc: 'æ—¢ã«Sealedãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«å†åº¦Î¨', blocked: 'FW-Î¨', detail: 'sealed=true â†’ Î¨ firewall ãŒã€Œæ—¢ã«å°å°æ¸ˆã¿ã€ã¨ã—ã¦æ‹’å¦' },
  { cat: 'Compact Proof Attack', name: 'transformCountæ”¹ç«„', desc: 'compactProof.transformCount ã‚’æ°´å¢—ã—', blocked: 'verify', detail: 'verifyCompactProof: å®Ÿéš›ã® transitions.length ã¨ã®ç…§åˆã§æ¤œå‡º' },
  { cat: 'Compact Proof Attack', name: 'phaseProgressionæ”¹ç«„', desc: 'åˆ°é”ãƒ•ã‚§ãƒ¼ã‚ºã‚’å½è£…', blocked: 'verify', detail: 'verifyCompactProof: å®Ÿéš›ã® phaseIndex ã¨ã®ç…§åˆã§æ¤œå‡º' },
  { cat: 'Compact Proof Attack', name: 'markChainHashæ”¹ç«„', desc: 'compactå†…ã®markChainHashã‚’å·®ã—æ›¿ãˆ', blocked: 'verify', detail: 'sealProof.markChainHash ã¨ã®äºŒé‡ç…§åˆã§æ¤œå‡º' },
  { cat: 'Compact Proof Attack', name: 'allCSHeldæ”¹ç«„', desc: 'compactå†…ã®CSãƒ•ãƒ©ã‚°ã‚’trueå½è£…', blocked: 'verify', detail: 'witnesses å†èµ°æŸ»ã«ã‚ˆã‚‹ cs.holds AND å†è¨ˆç®—ã¨ç…§åˆ' },
  // Additional patterns to reach 31
  { cat: 'Replay Attack', name: 'æ—§witnesså†åˆ©ç”¨', desc: 'éå»ã®æ­£è¦witnessã‚’åˆ¥ã®é·ç§»ã«æµç”¨', blocked: 'Î¦-pre', detail: 'witness.payload.from/to ãŒç¾åœ¨ã®é·ç§»ã¨ä¸ä¸€è‡´ â†’ ç¨®åˆ¥æ¤œè¨¼ã§æ¤œå‡º' },
  { cat: 'Replay Attack', name: 'æ—§sealProofå†åˆ©ç”¨', desc: 'åˆ¥ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®sealProofã‚’ç§»æ¤', blocked: 'FW-Î©', detail: 'snapshot å†…ã® invariants ãŒç¾ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨ä¸ä¸€è‡´ â†’ ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼å¤±æ•—' },
  { cat: 'Injection Attack', name: 'JSON prototypeæ±šæŸ“', desc: 'payload ã« __proto__ ã‚­ãƒ¼ã‚’æ³¨å…¥', blocked: 'Î¦-pre', detail: 'ãƒãƒƒã‚·ãƒ¥è¨ˆç®—ã« JSON.stringify ä½¿ç”¨ â†’ ä½™è¨ˆãªã‚­ãƒ¼ã§ãƒãƒƒã‚·ãƒ¥å¤‰åŒ–' },
  { cat: 'Timing Attack', name: 'tickå·»ãæˆ»ã—', desc: 'state.tick ã‚’éå»ã®å€¤ã«æˆ»ã™', blocked: 'Î¦-post', detail: 'tick ã®å˜èª¿å¢—åŠ ãƒã‚§ãƒƒã‚¯ â†’ æ¸›å°‘ã‚’æ¤œå‡ºã—ã¦æ‹’å¦' },
  { cat: 'Timing Attack', name: 'tické£›ã°ã—', desc: 'state.tick ã‚’å¤§å¹…ã«å…ˆã®å€¤ã«è¨­å®š', blocked: 'Î¨-post', detail: 'witness.payload.tick ã¨ state.tick ã®å·®åˆ†æ¤œè¨¼ â†’ éé€£ç¶šã‚’æ¤œå‡º' },
];

// === Education Questions ===
const QUESTIONS = [
  {
    cat: 'ISL ä¸å¯é€†æ§‹æ–‡', num: 'Q1',
    text: 'ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚ã©ã®è¡ŒãŒåŸå› ã§ã™ã‹ï¼Ÿ',
    code: `let p = createPipeline(genesisState);   // L1: OpenPipeline
p = applyRule(p, RULE_PHI_NORMALIZE);   // L2: OpenPipeline
const s = applyRule(p, RULE_PSI_COMMIT); // L3: SealedPipeline
phiNormalize(s);                         // L4: ???`,
    choices: [
      'L1: createPipeline ã®æˆ»ã‚Šå€¤å‹ãŒä¸æ­£',
      'L2: RULE_PHI_NORMALIZE ã¯ Sealed ã«ã—ã‹é©ç”¨ã§ããªã„',
      'L3: PSI_COMMIT ã®å‰ã« PHI_NORMALIZE ãŒå¿…è¦ï¼ˆå®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ï¼‰',
      'L4: SealedPipeline ã‚’ OpenPipeline å¼•æ•°ã«æ¸¡ã›ãªã„ï¼ˆå‹ã‚¨ãƒ©ãƒ¼ï¼‰',
    ],
    answer: 3,
    explanation: 'SealedPipeline ã¨ OpenPipeline ã¯åˆ¤åˆ¥å…±ç”¨ä½“ï¼ˆdiscriminated unionï¼‰ã§åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™ã€‚phiNormalize() ã®å¼•æ•°å‹ã¯ OpenPipeline ã®ã¿ã‚’å—ã‘ä»˜ã‘ã‚‹ãŸã‚ã€SealedPipeline ã‚’æ¸¡ã™ã¨ TS2345 ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã‚ŒãŒISLã®ã€Œå‹ãƒ¬ãƒ™ãƒ«ä¸å¯é€†æ€§ã€ã®æ ¸å¿ƒã§ã™ã€‚',
  },
  {
    cat: 'ISL ä¸å¯é€†æ§‹æ–‡', num: 'Q2',
    text: 'applyRule ã®å†…éƒ¨å‡¦ç†é †åºã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ',
    code: `const result = applyRule(pipeline, RULE_PHI_NORMALIZE);`,
    choices: [
      'apply â†’ firewall â†’ pre â†’ post â†’ mark â†’ record',
      'firewall â†’ pre â†’ apply â†’ post â†’ mark â†’ record',
      'pre â†’ firewall â†’ apply â†’ mark â†’ post â†’ record',
      'firewall â†’ apply â†’ pre â†’ post â†’ record â†’ mark',
    ],
    answer: 1,
    explanation: 'applyRule ã®6ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€Œfirewall â†’ pre â†’ apply â†’ post â†’ mark â†’ recordã€ã®é †åºã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚æœ€åˆã«firewallã§æ®µéšãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼šSealedãªã‚‰æ‹’å¦ï¼‰ã€pre ã§äº‹å‰æ¡ä»¶æ¤œè¨¼ã€apply ã§å¤‰æ›å®Ÿè¡Œã€post ã§ä¸å¤‰é‡æ¤œè¨¼ã€mark ã§ãƒãƒ¼ã‚¯è¨˜éŒ²ã€record ã§ witness è¨˜éŒ²ã®é †ã§ã™ã€‚',
  },
  {
    cat: 'ISL ä¸å¯é€†æ§‹æ–‡', num: 'Q3',
    text: 'æ”»æ’ƒè€…ãŒ `as unknown as OpenPipeline` ã§SealedPipelineã‚’Openã«å‹ã‚­ãƒ£ã‚¹ãƒˆã—ã¾ã—ãŸã€‚ä½•ãŒèµ·ã“ã‚Šã¾ã™ã‹ï¼Ÿ',
    code: `const sealed: SealedPipeline = applyRule(open, RULE_PSI_COMMIT);
const hacked = sealed as unknown as OpenPipeline;
phiNormalize(hacked); // ???`,
    choices: [
      'ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ï¼ˆas unknown ã§ã‚‚é˜²ã’ã‚‹ï¼‰',
      'æ­£å¸¸å‹•ä½œï¼ˆå‹ã‚­ãƒ£ã‚¹ãƒˆãŒå„ªå…ˆã•ã‚Œã‚‹ï¼‰',
      'ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼: firewall ãŒ sealed=true ã‚’æ¤œå‡ºã—ã¦æ‹’å¦',
      'æœªå®šç¾©å‹•ä½œï¼ˆTypeScript ã®ä»•æ§˜å¤–ï¼‰',
    ],
    answer: 2,
    explanation: 'TypeScript ã® `as unknown as X` ã¯å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Œå…¨ã«è¿‚å›ã—ã¾ã™ãŒã€ISLã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚‚firewallã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚phiNormalize å†…éƒ¨ã§ sealed===true ã‚’æ¤œå‡ºã—ã€å³åº§ã« Error ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™ã€‚ã“ã‚ŒãŒã€Œå‹ãƒ¬ãƒ™ãƒ«ï¼‹ãƒ©ãƒ³ã‚¿ã‚¤ãƒ äºŒé‡ä¿è¨¼ã€ã§ã™ã€‚æ•µå¯¾çš„ãƒ†ã‚¹ãƒˆ31ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã†ã¡4ã¤ãŒã“ã®å‹ã‚­ãƒ£ã‚¹ãƒˆè¿‚å›ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚',
  },
  {
    cat: 'GA-v2 ç”Ÿæˆå…¬ç†ç³»', num: 'Q4',
    text: 'energy=0.3 ã§ runFullGenesis ã‚’å®Ÿè¡Œã—ãŸå ´åˆã€dotâ†’zero_zero ã®é·ç§»ï¼ˆG-Sâ‚€ï¼‰ã¯ä½•tickç›®ã«ç™ºç”Ÿã—ã¾ã™ã‹ï¼Ÿï¼ˆthreshold=0.35, åˆæœŸcurvature=0, é·ç§»å¾Œcurvature resetï¼‰',
    code: `const result = runFullGenesis(0.3);
// voidâ†’dot: threshold=0.1, curvature accumulates 0.3/tick
// tick 1: curvature=0.3 â‰¥ 0.1 â†’ voidâ†’dot, curvature reset
// dotâ†’zero_zero: threshold=0.35
// tick 2: curvature=0.3
// tick 3: curvature=0.6 â‰¥ 0.35 â†’ ???`,
    choices: [
      'tick 2',
      'tick 3',
      'tick 4',
      'tick 5',
    ],
    answer: 1,
    explanation: 'voidâ†’dot ã¯ tick 1 ã§ç™ºç”Ÿï¼ˆ0.3 â‰¥ 0.1ï¼‰ã—ã€curvature ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚tick 2 ã§ curvature=0.3ï¼ˆ< 0.35ï¼‰ã€tick 3 ã§ curvature=0.6 â‰¥ 0.35 ãªã®ã§ã€G-Sâ‚€ ã¯ tick 3 ã§ç™ºç”Ÿã—ã¾ã™ã€‚computeProgress ã¯ energized stateï¼ˆåŠ ç®—å¾Œï¼‰ã§è¨ˆç®—ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®è¨ˆç®—ãŒæ­£ç¢ºã§ã™ï¼ˆFIX-1 ã®ä¿®æ­£å†…å®¹ï¼‰ã€‚',
  },
  {
    cat: 'GA-v2 ç”Ÿæˆå…¬ç†ç³»', num: 'Q5',
    text: 'CSï¼ˆä¸€èˆ¬ä½ç½®ä»®å®šï¼‰ãŒæˆç«‹ã—ãªã„æ¡ä»¶ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ',
    code: `interface CSAssumption {
  holds: boolean;
  structurePositive: boolean;  // structure > 0
  energyPositive: boolean;     // energy > 0
  entropyPositive: boolean;    // entropy > 0
}`,
    choices: [
      'curvature ãŒ threshold ã‚’è¶…ãˆãŸå ´åˆ',
      'entropy ãŒ 0 ã«æ¸›è¡°ã—ãŸå ´åˆ',
      'phase ãŒ number ã«åˆ°é”ã—ãŸå ´åˆ',
      'tick ãŒ 100 ã‚’è¶…ãˆãŸå ´åˆ',
    ],
    answer: 1,
    explanation: 'CS ã¯ã€Œstructure > 0 ã‹ã¤ energy > 0 ã‹ã¤ entropy > 0ã€ã®3æ¡ä»¶ã®ANDã§ã™ã€‚entropy ã¯æ¯tick ENTROPY_DECAY (0.02) ãšã¤æ¸›è¡°ã™ã‚‹ãŸã‚ã€ååˆ†ãª tick æ•°ãŒçµŒéã™ã‚‹ã¨ entropy=0 ã¨ãªã‚Š CS ãŒç ´ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ Sâ‚€/Sâ‚ ã®ä¸€æ„æ€§å®šç†ãŒã€Œä»®å®šã¤ãã€ã§ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã€witness.payload.cs ã«è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚',
  },
  {
    cat: 'Center/Neighbor', num: 'Q6',
    text: 'ä»¥ä¸‹ã®ç”»åƒã‚«ãƒ¼ãƒãƒ«è¨ˆç®—ã§ã€Reiè¨˜æ³•ãŒ Python ã‚ˆã‚Šç°¡æ½”ã«ãªã‚‹ç†ç”±ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ',
    code: `// Python (32è¡Œ)
for y in range(1, h-1):
  for x in range(1, w-1):
    total = 0
    for dy in [-1, 0, 1]:
      for dx in [-1, 0, 1]:
        total += img[y+dy][x+dx] * kernel[dy+1][dx+1]
    result[y][x] = total

// Rei (8è¡Œ)
grid |> convolve(kernel)`,
    choices: [
      'Rei ã¯ GPU ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ã‚‰',
      'center/neighbor ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¨€èªãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã ã‹ã‚‰',
      'Rei ã®ãƒ«ãƒ¼ãƒ—æ§‹æ–‡ãŒ Python ã‚ˆã‚ŠçŸ­ã„ã‹ã‚‰',
      'Rei ã¯è‡ªå‹•ä¸¦åˆ—åŒ–ã‚’è¡Œã†ã‹ã‚‰',
    ],
    answer: 1,
    explanation: '4é‡ãƒ«ãƒ¼ãƒ—ï¼ˆy, x, dy, dxï¼‰ãŒå…¨ã¦ã€Œcenter/neighbor ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã®è¡¨ç¾ã§ã™ã€‚Reiã§ã¯ã“ã‚ŒãŒè¨€èªãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã¨ã—ã¦çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€é–‹ç™ºè€…ã¯ã€Œä½•ã‚’è¨ˆç®—ã™ã‚‹ã‹ã€ã ã‘ã‚’æ›¸ã‘ã°ã‚ˆãã€ã€Œã©ã†èµ°æŸ»ã™ã‚‹ã‹ã€ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚ŒãŒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§4Ã—ï¼ˆ32â†’8è¡Œï¼‰ã®ã‚³ãƒ¼ãƒ‰å‰Šæ¸›ã‚’å®Ÿç¾ã—ãŸæ ¹æœ¬çš„å„ªä½æ€§ã§ã™ã€‚',
  },
];

// ============================================================
// UI Rendering
// ============================================================

let currentTab = 'tracer';
let genesisState = null;
let genesisHistory = [];
let pipelineState = null;
let pipelineHistory = [];
let genTick = 0;
let eduAnswered = {};

// === Tab Switching ===
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    const id = tab.dataset.tab;
    document.getElementById('panel-' + id).classList.add('active');
    currentTab = id;
  });
});

// === Pipeline Tracer ===
const energySlider = document.getElementById('energy-slider');
const energyVal = document.getElementById('energy-val');
energySlider.addEventListener('input', () => {
  energyVal.textContent = parseFloat(energySlider.value).toFixed(2);
});

document.getElementById('btn-run').addEventListener('click', () => {
  const e = parseFloat(energySlider.value);
  const result = runFullGenesis(e);
  genesisState = result.final;
  genesisHistory = result.history;
  pipelineState = createPipelineState(genesisState);
  pipelineHistory = [JSON.parse(JSON.stringify(pipelineState))];
  // Run all steps
  while (pipelineState.stageIndex < PIPELINE_STAGES.length) {
    pipelineState = advancePipeline(pipelineState, genesisState);
    pipelineHistory.push(JSON.parse(JSON.stringify(pipelineState)));
    if (pipelineState.history.length > 0 && pipelineState.history[pipelineState.history.length-1].rejected) break;
  }
  renderTimeline();
  renderGraph(pipelineHistory.length - 1);
  renderInspector(pipelineHistory.length - 1);
  renderDiff(pipelineHistory.length - 1);
});

document.getElementById('btn-step').addEventListener('click', () => {
  if (!genesisState) {
    const e = parseFloat(energySlider.value);
    const result = runFullGenesis(e);
    genesisState = result.final;
    genesisHistory = result.history;
    pipelineState = createPipelineState(genesisState);
    pipelineHistory = [JSON.parse(JSON.stringify(pipelineState))];
  }
  if (pipelineState.stageIndex < PIPELINE_STAGES.length) {
    pipelineState = advancePipeline(pipelineState, genesisState);
    pipelineHistory.push(JSON.parse(JSON.stringify(pipelineState)));
  }
  const idx = pipelineHistory.length - 1;
  renderTimeline();
  renderGraph(idx);
  renderInspector(idx);
  renderDiff(idx);
});

document.getElementById('btn-reset').addEventListener('click', () => {
  genesisState = null;
  pipelineState = null;
  pipelineHistory = [];
  document.getElementById('pipeline-timeline').innerHTML = '';
  document.getElementById('gft-svg').innerHTML = '';
  document.getElementById('diff-content').innerHTML = '';
  document.getElementById('inspect-state').innerHTML = '';
  document.getElementById('inspect-witness').innerHTML = '';
});

function renderTimeline() {
  const el = document.getElementById('pipeline-timeline');
  el.innerHTML = '';
  PIPELINE_STAGES.forEach((stage, i) => {
    const step = document.createElement('div');
    step.className = 'timeline-step';

    const node = document.createElement('div');
    node.className = 'step-node';
    const histEntry = pipelineHistory.find(h => {
      const last = h.history[h.history.length - 1];
      return last && last.stage === stage.id;
    });
    const wasRejected = histEntry && histEntry.history.find(h => h.stage === stage.id && h.rejected);

    if (wasRejected) {
      node.classList.add('rejected');
    } else if (pipelineState && i < pipelineState.stageIndex) {
      node.classList.add('completed');
    } else if (pipelineState && i === pipelineState.stageIndex) {
      node.classList.add('current');
    }

    const shortLabel = stage.label.length > 4 ? stage.label.slice(0, 4) : stage.label;
    node.innerHTML = `${shortLabel}<span class="step-label">${stage.label}</span>`;
    node.addEventListener('click', () => {
      const idx = Math.min(i + 1, pipelineHistory.length - 1);
      renderGraph(idx);
      renderInspector(idx);
      renderDiff(idx);
    });

    step.appendChild(node);

    if (i < PIPELINE_STAGES.length - 1) {
      const conn = document.createElement('div');
      conn.className = 'step-connector';
      if (wasRejected) conn.classList.add('rejected');
      else if (pipelineState && i < pipelineState.stageIndex) conn.classList.add('completed');
      step.appendChild(conn);
    }

    el.appendChild(step);
  });
}

function renderGraph(idx) {
  const svg = document.getElementById('gft-svg');
  if (!pipelineHistory[idx]) { svg.innerHTML = ''; return; }
  const state = pipelineHistory[idx];
  const W = 1000, H = 400;
  const cx = W / 2, cy = H / 2;

  let html = `<defs>
    <marker id="arrowG" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#5ec47a" opacity="0.7"/>
    </marker>
    <marker id="arrowR" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#c46565" opacity="0.7"/>
    </marker>
    <marker id="arrowGold" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#c4a265" opacity="0.7"/>
    </marker>
    <filter id="glow"><feGaussianBlur stdDeviation="3" result="g"/><feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
  </defs>`;

  // Draw pipeline stages as GFT nodes (radial layout)
  const stages = PIPELINE_STAGES;
  const stagePositions = [];
  const cols = 7;
  const rows = 2;
  const spacingX = 120;
  const spacingY = 140;
  const startX = cx - (cols - 1) * spacingX / 2;
  const startY = cy - (rows - 1) * spacingY / 2;

  stages.forEach((stage, i) => {
    const row = Math.floor(i / cols);
    const col = row === 0 ? (i % cols) : (cols - 1 - (i % cols)); // Snake layout
    const x = startX + col * spacingX;
    const y = startY + row * spacingY;
    stagePositions.push({ x, y, stage });
  });

  // Draw edges
  for (let i = 0; i < stagePositions.length - 1; i++) {
    const p1 = stagePositions[i];
    const p2 = stagePositions[i + 1];
    const isCompleted = state.stageIndex > i + 1;
    const isRejected = state.history.find(h => h.stage === stages[i + 1].id && h.rejected);
    const color = isRejected ? '#c46565' : (isCompleted ? '#5ec47a' : '#2a2a4a');
    const marker = isRejected ? 'url(#arrowR)' : (isCompleted ? 'url(#arrowG)' : '');
    const dash = isRejected ? 'stroke-dasharray="6 4"' : '';

    html += `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="${color}" stroke-width="2" ${dash} marker-end="${marker}" opacity="0.6"/>`;
  }

  // Draw nodes
  stagePositions.forEach((pos, i) => {
    const stage = stages[i];
    const isCurrent = state.stageIndex === i;
    const isCompleted = state.stageIndex > i;
    const isRejected = state.history.find(h => h.stage === stage.id && h.rejected);

    let fillColor = '#111122';
    let strokeColor = '#2a2a4a';
    let textColor = '#5a5670';
    let r = 28;

    if (isRejected) {
      fillColor = 'rgba(196,101,101,0.15)';
      strokeColor = '#c46565';
      textColor = '#c46565';
    } else if (isCurrent) {
      fillColor = 'rgba(196,162,101,0.12)';
      strokeColor = '#c4a265';
      textColor = '#c4a265';
      r = 32;
    } else if (isCompleted) {
      fillColor = 'rgba(94,196,122,0.1)';
      strokeColor = '#5ec47a';
      textColor = '#5ec47a';
    }

    const filter = isCurrent ? ' filter="url(#glow)"' : '';

    // Node type icon
    let icon = '';
    if (stage.type === 'check') icon = 'â—‡';
    else if (stage.type === 'transform') icon = 'â¬¡';
    else if (stage.type === 'mark') icon = 'â—';
    else if (stage.type === 'seal') icon = 'ğŸ”’';
    else if (stage.type === 'compact') icon = 'â—†';
    else icon = 'â—‹';

    html += `<g${filter}>
      <circle cx="${pos.x}" cy="${pos.y}" r="${r}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2"/>
      <text x="${pos.x}" y="${pos.y - 5}" text-anchor="middle" fill="${textColor}" font-family="IBM Plex Mono" font-size="10" font-weight="500">${stage.label}</text>
      <text x="${pos.x}" y="${pos.y + 12}" text-anchor="middle" fill="${textColor}" font-family="serif" font-size="14" opacity="0.6">${icon}</text>
    </g>`;

    // Stage type label (only for key stages)
    if (stage.id === 'psi_seal') {
      html += `<text x="${pos.x}" y="${pos.y + r + 18}" text-anchor="middle" fill="#c4a265" font-family="IBM Plex Mono" font-size="9" opacity="0.7">Open â†’ Sealed</text>`;
    } else if (stage.id === 'omega_compact') {
      html += `<text x="${pos.x}" y="${pos.y + r + 18}" text-anchor="middle" fill="#c4a265" font-family="IBM Plex Mono" font-size="9" opacity="0.7">Sealed â†’ Compacted</text>`;
    }
  });

  // Pipeline stage label
  const stageLabel = state.compacted ? 'CompactedPipeline' : (state.sealed ? 'SealedPipeline' : 'OpenPipeline');
  const stageLabelColor = state.compacted ? '#9b7ed8' : (state.sealed ? '#c4a265' : '#5a8fc5');
  html += `<text x="${W/2}" y="30" text-anchor="middle" fill="${stageLabelColor}" font-family="Cormorant Garamond" font-size="20" font-weight="500">${stageLabel}</text>`;

  svg.innerHTML = html;
}

function renderInspector(idx) {
  const stateEl = document.getElementById('inspect-state');
  const witnessEl = document.getElementById('inspect-witness');
  if (!pipelineHistory[idx]) {
    stateEl.innerHTML = '<div class="kv-row"><span class="kv-key">â€”</span></div>';
    witnessEl.innerHTML = '<div class="kv-row"><span class="kv-key">â€”</span></div>';
    return;
  }
  const s = pipelineHistory[idx];

  stateEl.innerHTML = `
    <div class="kv-row"><span class="kv-key">stage</span><span class="kv-val ${s.compacted?'purple':s.sealed?'gold':'blue'}">${s.compacted?'Compacted':s.sealed?'Sealed':'Open'}</span></div>
    <div class="kv-row"><span class="kv-key">step</span><span class="kv-val">${s.stageIndex} / ${PIPELINE_STAGES.length}</span></div>
    <div class="kv-row"><span class="kv-key">genesisPhase</span><span class="kv-val gold">${s.genesisPhase}</span></div>
    <div class="kv-row"><span class="kv-key">transitionCount</span><span class="kv-val">${s.invariants.transitionCount}</span></div>
    <div class="kv-row"><span class="kv-key">witnessCount</span><span class="kv-val">${s.invariants.witnessCount}</span></div>
    <div class="kv-row"><span class="kv-key">phaseProgression</span><span class="kv-val">${s.invariants.phaseProgression}</span></div>
    <div class="kv-row"><span class="kv-key">allCSHeld</span><span class="kv-val ${s.invariants.allCSHeld?'green':'red'}">${s.invariants.allCSHeld}</span></div>
    <div class="kv-row"><span class="kv-key">normalized</span><span class="kv-val ${s.normalized?'green':'red'}">${s.normalized}</span></div>
    <div class="kv-row"><span class="kv-key">marks</span><span class="kv-val">${s.marks.length}</span></div>
  `;

  let witnessHtml = '';
  if (s.sealProof) {
    witnessHtml += `
      <div class="kv-row"><span class="kv-key">sealProof.hash</span><span class="kv-val gold">${s.sealProof.hash}</span></div>
      <div class="kv-row"><span class="kv-key">markChainHash</span><span class="kv-val">${s.sealProof.markChainHash}</span></div>
      <div class="kv-row"><span class="kv-key">allCSHeld</span><span class="kv-val ${s.sealProof.allCSHeld?'green':'red'}">${s.sealProof.allCSHeld}</span></div>
    `;
  }
  if (s.compactProof) {
    witnessHtml += `
      <div class="kv-row" style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border)"><span class="kv-key">compactProof.hash</span><span class="kv-val purple">${s.compactProof.hash}</span></div>
      <div class="kv-row"><span class="kv-key">sealHash</span><span class="kv-val">${s.compactProof.sealHash}</span></div>
      <div class="kv-row"><span class="kv-key">transformCount</span><span class="kv-val">${s.compactProof.transformCount}</span></div>
      <div class="kv-row"><span class="kv-key">phaseProgression</span><span class="kv-val">${s.compactProof.phaseProgression}</span></div>
    `;
  }
  if (!s.sealProof && !s.compactProof) {
    witnessHtml = '<div class="kv-row"><span class="kv-key">ï¼ˆæœªå°å°ï¼‰</span></div>';
  }
  witnessEl.innerHTML = witnessHtml;
}

function renderDiff(idx) {
  const el = document.getElementById('diff-content');
  if (!pipelineHistory[idx]) { el.innerHTML = ''; return; }

  const s = pipelineHistory[idx];
  let html = '';
  s.history.forEach(h => {
    const cls = h.rejected ? 'removed' : 'added';
    const prefix = h.rejected ? 'âœ—' : 'âœ“';
    html += `<div class="diff-line ${cls}"><span class="prefix">${prefix}</span> [${h.stage}] ${h.msg}</div>`;
  });
  el.innerHTML = html;
}

// === Genesis Viewer ===
let genState = null;
let genHistory = [];

const genEnergySlider = document.getElementById('gen-energy');
const genEnergyVal = document.getElementById('gen-energy-val');
genEnergySlider.addEventListener('input', () => {
  genEnergyVal.textContent = parseFloat(genEnergySlider.value).toFixed(2);
});

document.getElementById('btn-gen-run').addEventListener('click', () => {
  const e = parseFloat(genEnergySlider.value);
  const result = runFullGenesis(e);
  genState = result.final;
  genHistory = result.history;
  genTick = genHistory.length - 1;
  renderGenesisTrack();
  renderGenesisInfo();
  renderGenesisSVG();
});

document.getElementById('btn-gen-step').addEventListener('click', () => {
  if (!genState) {
    genState = createGenesisState(parseFloat(genEnergySlider.value));
    genHistory = [{ ...genState }];
    genTick = 0;
  }
  if (genState.phase !== 'number') {
    genState = genesisStep(genState);
    genHistory.push({ ...genState });
    genTick = genHistory.length - 1;
  }
  renderGenesisTrack();
  renderGenesisInfo();
  renderGenesisSVG();
});

document.getElementById('btn-gen-reset').addEventListener('click', () => {
  genState = null;
  genHistory = [];
  genTick = 0;
  document.getElementById('genesis-track').innerHTML = '';
  document.getElementById('gen-state-info').innerHTML = '';
  document.getElementById('gen-history').innerHTML = '';
  document.getElementById('genesis-svg').innerHTML = '';
});

function renderGenesisTrack() {
  const el = document.getElementById('genesis-track');
  el.innerHTML = '';
  const currentIdx = genState ? PHASES.indexOf(genState.phase) : -1;

  PHASES.forEach((phase, i) => {
    const phaseEl = document.createElement('div');
    phaseEl.className = 'genesis-phase';

    const circle = document.createElement('div');
    circle.className = 'phase-circle';
    if (i <= currentIdx) circle.classList.add('reached');
    if (i === currentIdx) circle.classList.add('active-phase');

    const symbol = document.createElement('span');
    symbol.className = 'phase-symbol';
    symbol.textContent = PHASE_SYMBOLS[phase];
    circle.appendChild(symbol);

    const name = document.createElement('div');
    name.className = 'phase-name';
    name.textContent = phase;

    phaseEl.appendChild(circle);
    phaseEl.appendChild(name);
    el.appendChild(phaseEl);

    if (i < PHASES.length - 1) {
      const arrow = document.createElement('div');
      arrow.className = 'genesis-arrow';
      if (i < currentIdx) arrow.classList.add('reached');

      const label = document.createElement('span');
      label.className = 'axiom-label';
      label.textContent = PHASE_AXIOMS[i + 1];
      arrow.appendChild(label);

      el.appendChild(arrow);
    }
  });
}

function renderGenesisInfo() {
  const stateEl = document.getElementById('gen-state-info');
  const histEl = document.getElementById('gen-history');

  if (!genState) {
    stateEl.innerHTML = '<div class="kv-row"><span class="kv-key">â€”</span></div>';
    histEl.innerHTML = '';
    return;
  }

  const s = genState;
  const progress = computeProgress(s);

  stateEl.innerHTML = `
    <div class="kv-row"><span class="kv-key">phase</span><span class="kv-val gold">${s.phase} (${PHASE_SYMBOLS[s.phase]})</span></div>
    <div class="kv-row"><span class="kv-key">tick</span><span class="kv-val">${s.tick}</span></div>
    <div class="kv-row"><span class="kv-key">curvature</span><span class="kv-val">${s.curvature.toFixed(4)}</span></div>
    <div class="kv-row"><span class="kv-key">entropy</span><span class="kv-val ${s.entropy>0?'green':'red'}">${s.entropy.toFixed(4)}</span></div>
    <div class="kv-row"><span class="kv-key">structure</span><span class="kv-val">${s.structure.toFixed(4)}</span></div>
    <div class="kv-row"><span class="kv-key">progress</span><span class="kv-val ${progress>=1?'gold':'blue'}">${(progress*100).toFixed(1)}%</span></div>
    <div class="kv-row"><span class="kv-key">transitions</span><span class="kv-val">${s.transitions.length}</span></div>
    <div class="kv-row"><span class="kv-key">witnesses</span><span class="kv-val">${s.witnesses.length}</span></div>
  `;

  let histHtml = '';
  s.transitions.forEach(t => {
    histHtml += `<div class="kv-row"><span class="kv-key">tick ${t.tick}</span><span class="kv-val gold">${t.from}â†’${t.to} [${t.axiom}]</span></div>`;
  });
  if (s.transitions.length === 0) {
    histHtml = '<div class="kv-row"><span class="kv-key">ï¼ˆé·ç§»ãªã—ï¼‰</span></div>';
  }
  histEl.innerHTML = histHtml;
}

function renderGenesisSVG() {
  const svg = document.getElementById('genesis-svg');
  if (genHistory.length < 2) { svg.innerHTML = ''; return; }

  const W = 1000, H = 350;
  const margin = { top: 30, right: 40, bottom: 40, left: 60 };
  const gW = W - margin.left - margin.right;
  const gH = H - margin.top - margin.bottom;

  const maxTick = genHistory[genHistory.length - 1].tick || 1;

  let html = '';

  // Grid
  for (let i = 0; i <= 4; i++) {
    const y = margin.top + gH * (1 - i / 4);
    html += `<line x1="${margin.left}" y1="${y}" x2="${W-margin.right}" y2="${y}" stroke="#1e1e3a" stroke-width="1"/>`;
    html += `<text x="${margin.left-8}" y="${y+4}" text-anchor="end" fill="#5a5670" font-family="IBM Plex Mono" font-size="9">${(i/4).toFixed(1)}</text>`;
  }

  // Axes
  html += `<text x="${margin.left-8}" y="${margin.top-10}" fill="#5a5670" font-family="IBM Plex Mono" font-size="9">value</text>`;
  html += `<text x="${W-margin.right}" y="${H-8}" text-anchor="end" fill="#5a5670" font-family="IBM Plex Mono" font-size="9">tick</text>`;

  // Data lines
  const lines = [
    { key: 'curvature', color: '#c4a265', label: 'curvature' },
    { key: 'entropy', color: '#5ec47a', label: 'entropy' },
    { key: 'structure', color: '#5a8fc5', label: 'structure' },
  ];

  lines.forEach(line => {
    let path = '';
    genHistory.forEach((s, i) => {
      const x = margin.left + (s.tick / maxTick) * gW;
      const val = Math.min(1, Math.max(0, s[line.key]));
      const y = margin.top + gH * (1 - val);
      path += (i === 0 ? 'M' : 'L') + `${x},${y}`;
    });
    html += `<path d="${path}" fill="none" stroke="${line.color}" stroke-width="1.5" opacity="0.8"/>`;
  });

  // Transition markers
  genHistory.forEach(s => {
    if (s.transitions && s.transitions.length > 0) {
      s.transitions.forEach(t => {
        const x = margin.left + (t.tick / maxTick) * gW;
        html += `<line x1="${x}" y1="${margin.top}" x2="${x}" y2="${margin.top+gH}" stroke="#c4a265" stroke-width="1" stroke-dasharray="4 4" opacity="0.4"/>`;
        html += `<text x="${x}" y="${margin.top-5}" text-anchor="middle" fill="#c4a265" font-family="IBM Plex Mono" font-size="8">${t.axiom}</text>`;
      });
    }
  });

  // Legend
  const legendY = H - 12;
  lines.forEach((line, i) => {
    const x = margin.left + i * 120;
    html += `<line x1="${x}" y1="${legendY}" x2="${x+16}" y2="${legendY}" stroke="${line.color}" stroke-width="2"/>`;
    html += `<text x="${x+22}" y="${legendY+4}" fill="${line.color}" font-family="IBM Plex Mono" font-size="9">${line.label}</text>`;
  });

  svg.innerHTML = html;
}

// === Attack Replay ===
function renderAttacks() {
  const grid = document.getElementById('attack-grid');
  grid.innerHTML = '';
  ATTACKS.forEach((atk, i) => {
    const card = document.createElement('div');
    card.className = 'attack-card';
    card.innerHTML = `
      <div class="attack-category">${atk.cat}</div>
      <div class="attack-name">${atk.name}</div>
      <div class="attack-desc">${atk.desc}</div>
      <div class="attack-result">
        <span class="blocked">ğŸ›¡ Blocked at: </span>
        <span class="stage">${atk.blocked}</span>
      </div>
    `;
    card.addEventListener('click', () => {
      document.querySelectorAll('.attack-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      showAttackDetail(atk);
    });
    grid.appendChild(card);
  });
}

function showAttackDetail(atk) {
  const el = document.getElementById('attack-detail');
  el.style.display = 'block';

  // Render attack timeline
  const timeline = document.getElementById('attack-timeline');
  timeline.innerHTML = '';
  const blockedStage = PIPELINE_STAGES.find(s => s.label === atk.blocked);
  const blockedIdx = blockedStage ? PIPELINE_STAGES.indexOf(blockedStage) : -1;

  PIPELINE_STAGES.forEach((stage, i) => {
    const step = document.createElement('div');
    step.className = 'timeline-step';
    const node = document.createElement('div');
    node.className = 'step-node';
    if (i < blockedIdx) node.classList.add('completed');
    else if (i === blockedIdx) node.classList.add('rejected');
    node.innerHTML = `${stage.label.slice(0,4)}<span class="step-label">${stage.label}</span>`;
    step.appendChild(node);
    if (i < PIPELINE_STAGES.length - 1) {
      const conn = document.createElement('div');
      conn.className = 'step-connector';
      if (i < blockedIdx) conn.classList.add('completed');
      else if (i === blockedIdx) conn.classList.add('rejected');
      step.appendChild(conn);
    }
    el.querySelector('#attack-timeline').appendChild(step);
  });

  // Render analysis
  const analysis = document.getElementById('attack-analysis');
  analysis.innerHTML = `
    <div class="diff-line removed"><span class="prefix">âœ—</span> Attack: ${atk.name} â€” ${atk.desc}</div>
    <div class="diff-line added"><span class="prefix">âœ“</span> Blocked at: ${atk.blocked}</div>
    <div class="diff-line unchanged"><span class="prefix"> </span> ${atk.detail}</div>
  `;
}

renderAttacks();

// === Education ===
function renderEducation() {
  const el = document.getElementById('edu-questions');
  el.innerHTML = '';

  QUESTIONS.forEach((q, qi) => {
    const qEl = document.createElement('div');
    qEl.className = 'edu-question fade-in';
    qEl.style.animationDelay = `${qi * 0.1}s`;

    let choicesHtml = '';
    q.choices.forEach((c, ci) => {
      choicesHtml += `
        <li class="choice-item" data-q="${qi}" data-c="${ci}">
          <span class="choice-marker">${String.fromCharCode(65+ci)}</span>
          <span>${c}</span>
        </li>`;
    });

    qEl.innerHTML = `
      <div class="q-number">${q.cat} â€” ${q.num}</div>
      <div class="q-text">${q.text}</div>
      <div class="q-code">${q.code}</div>
      <ul class="choice-list">${choicesHtml}</ul>
      <div class="explanation" id="exp-${qi}">
        <div class="exp-title">è§£èª¬</div>
        ${q.explanation}
      </div>
    `;
    el.appendChild(qEl);
  });

  // Attach click handlers
  document.querySelectorAll('.choice-item').forEach(item => {
    item.addEventListener('click', () => {
      const qi = parseInt(item.dataset.q);
      const ci = parseInt(item.dataset.c);
      if (eduAnswered[qi] !== undefined) return;

      eduAnswered[qi] = ci;
      const correct = QUESTIONS[qi].answer;
      const isCorrect = ci === correct;

      // Highlight
      const siblings = document.querySelectorAll(`.choice-item[data-q="${qi}"]`);
      siblings.forEach(s => {
        const sc = parseInt(s.dataset.c);
        if (sc === correct) s.classList.add('correct');
        else if (sc === ci && !isCorrect) s.classList.add('wrong');
      });

      // Show explanation
      document.getElementById(`exp-${qi}`).classList.add('show');

      // Update score
      const correctCount = Object.values(eduAnswered).filter((v, i) => v === QUESTIONS[Object.keys(eduAnswered)[i]]?.answer).length;
      let c = 0, w = 0;
      Object.entries(eduAnswered).forEach(([k, v]) => {
        if (v === QUESTIONS[parseInt(k)].answer) c++; else w++;
      });
      document.getElementById('edu-correct').textContent = c;
      document.getElementById('edu-wrong').textContent = w;
      document.getElementById('edu-progress').textContent = `${Object.keys(eduAnswered).length} / ${QUESTIONS.length}`;
    });
  });

  document.getElementById('edu-progress').textContent = `0 / ${QUESTIONS.length}`;
}

renderEducation();
</script>
</body>
</html>
